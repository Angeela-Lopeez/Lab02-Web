<%- include('partials/header', { title: 'Mi cuenta' }) %>

<div id="profileArea" class="row">
  <div class="col s12 m8 offset-m2 card-panel">Cargando...</div>
</div>

<script>
(async function(){
  const token = sessionStorage.getItem('token');
  if (!token) return location.href = '/signIn';
  // token expiry check
  function isTokenExpired(token){ try{ const p=JSON.parse(atob(token.split('.')[1])); return p.exp && p.exp < Math.floor(Date.now()/1000); }catch(e){return true;} }
  if (isTokenExpired(token)){ sessionStorage.removeItem('token'); return location.href='/signIn'; }

  const res = await fetch('/api/users/me', { headers:{ Authorization: 'Bearer ' + token }});
  if (!res.ok) { sessionStorage.removeItem('token'); return location.href = '/signIn'; }
  const user = await res.json();

  document.getElementById('profileArea').innerHTML = `
    <div class="col s12 m8 offset-m2">
      <div class="card">
        <div class="card-content">
          <span class="card-title">${user.name} ${user.lastName}</span>
          <form id="editForm">
            <div class="input-field"><input name="name" value="${user.name}" required><label class="active">Nombre</label></div>
            <div class="input-field"><input name="lastName" value="${user.lastName}" required><label class="active">Apellido</label></div>
            <div class="input-field"><input name="phoneNumber" value="${user.phoneNumber}" required><label class="active">Teléfono</label></div>
            <div class="input-field"><input name="birthdate" type="date" value="${new Date(user.birthdate).toISOString().split('T')[0]}" required><label class="active">Fecha de nacimiento</label></div>
            <div class="input-field"><input name="address" value="${user.address || ''}"><label class="active">Dirección</label></div>
            <div class="input-field"><input name="url_profile" value="${user.url_profile || ''}"><label class="active">URL perfil</label></div>
            <button class="btn green" type="submit">Guardar cambios</button>
          </form>
        </div>
      </div>
    </div>
  `;

  document.getElementById('editForm').addEventListener('submit', async (ev) => {
    ev.preventDefault();
    const fd = Object.fromEntries(new FormData(ev.target).entries());
    // convert birthdate to ISO
    if (fd.birthdate) fd.birthdate = new Date(fd.birthdate).toISOString();
    const upd = await fetch('/api/users/me', {
      method: 'PATCH', headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
      body: JSON.stringify(fd)
    });
    const d = await upd.json();
    if (!upd.ok) { M.toast({html: d.message || 'Error', classes:'red'}); return; }
    M.toast({html: 'Perfil actualizado', classes:'green'});
    location.reload();
  });

})();
</script>

<%- include('partials/footer') %>
