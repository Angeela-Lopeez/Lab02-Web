<%- include('partials/header', { title: 'Dashboard admin' }) %>

<h5>Lista de usuarios</h5>
<table id="usersTable" class="striped responsive-table">
  <thead><tr><th>Nombre</th><th>Email</th><th>Roles</th><th>Registrado</th><th>Acciones</th></tr></thead>
  <tbody></tbody>
</table>

<script>
(async function(){
  const token = sessionStorage.getItem('token');
  if (!token) return location.href='/signIn';
  const res = await fetch('/api/users', { headers: { Authorization: 'Bearer ' + token }});
  if (res.status === 403) return location.href='/403';
  if (!res.ok) { M.toast({html:'Error al cargar usuarios', classes:'red'}); return; }
  const users = await res.json();
  document.querySelector('#usersTable tbody').innerHTML = users.map(u => `
    <tr>
      <td>${u.name} ${u.lastName || ''}</td>
      <td>${u.email}</td>
      <td>${u.roles?.join(', ')}</td>
      <td>${new Date(u.createdAt).toLocaleString()}</td>
      <td><button class="btn view" data-id="${u.id}">Ver</button></td>
    </tr>
  `).join('');
  document.querySelectorAll('.view').forEach(b => b.addEventListener('click', async (ev) => {
    const id = ev.target.dataset.id;
    const r = await fetch('/api/users/' + id, { headers: { Authorization: 'Bearer ' + token }});
    if (r.ok) {
      const info = await r.json();
      M.toast({html: JSON.stringify(info), classes:'green'});
    } else M.toast({html:'No se pudo obtener info', classes:'red'});
  }));
})();
</script>

<%- include('partials/footer') %>
